<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>VIP ì‹¤ë²„ ê³„ì•½ì„œ</title>
<style>
  body { font-family: "Malgun Gothic", Arial, sans-serif; margin: 24px; line-height: 1.6; color:#000; }
  h1, h2 { text-align:center; }
  .section { margin-top: 24px; }
  .checkbox-line { margin: 12px 0; }
  .signature-box { border: 1px solid #000; width: 100%; max-width: 360px; height: 160px; }
  .signature-box canvas { width: 100%; height: 100%; }
  table { width: 100%; border-collapse: collapse; margin-top: 16px; }
  td { padding: 6px; vertical-align: top; }
  .label { width: 110px; font-weight: bold; }
  .actions { margin-top: 24px; display:flex; gap:12px; flex-wrap:wrap; }
  button { padding: 10px 14px; font-size: 16px; }
  .hint { font-size: 12px; color:#444; }
</style>
</head>
<body>

<h1>ì›” êµ¬ë… ê°€ì…ê³„ì•½ì„œ</h1>
<h2>(VIP Silver Class)</h2>

<p>ãˆœí“¨ì²˜ì¸ë² ìŠ¤íŠ¸ë¦¬(ì´í•˜ â€œíšŒì‚¬â€ë¼ ì¹­í•¨)ì™€ ì •ê¸°íšŒì› OOO(ì´í•˜ â€œíšŒì›â€ì´ë¼ ì¹­í•¨)ì€ ë‹¤ìŒê³¼ ê°™ì´ ê³„ì•½ì„ ì²´ê²°í•œë‹¤.</p>

<div class="section">
  <h3>ì œ13ì¡° ã€ê°œì¸ì •ë³´ìˆ˜ì§‘ë™ì˜ ë“±ã€‘</h3>
  <div class="checkbox-line">
    <label>
      <input type="checkbox" id="agree1" />
      â— ê°œì¸ì •ë³´ ìˆ˜ì§‘ ì´ìš©ì— ë™ì˜í•¨. (ì²´í¬)
    </label>
  </div>
  <div class="checkbox-line">
    <label>
      <input type="checkbox" id="agree2" />
      â— ë³¸ì¸ì€ ì´ìš©ë°©ë²•ê³¼ ì±…ì„ë²”ìœ„ í™˜ë¶ˆê·œì •ì„ ì½ê³  ì´í•´í•˜ì˜€ìŠµë‹ˆë‹¤. (ì²´í¬)
    </label>
  </div>
</div>

<hr/>

<h3>(â€œíšŒì›â€) íšŒì›ì •ë³´</h3>
<table>
  <tr>
    <td class="label">ì„± í•¨</td>
    <td>
      <input type="text" id="name" placeholder="í™ê¸¸ë™" />
      &nbsp; ì„œëª…:
      <div class="signature-box">
        <canvas id="signCanvas"></canvas>
      </div>
      <div class="actions">
        <button type="button" onclick="clearSign()">ì„œëª… ì§€ìš°ê¸°</button>
      </div>
    </td>
  </tr>
  <tr>
    <td class="label">ì—° ë½ ì²˜</td>
    <td><input type="text" id="phone" placeholder="010-0000-0000" /></td>
  </tr>
</table>

<div class="actions">
  <button type="button" onclick="submitForm()">ì œì¶œ / ì €ì¥</button>
</div>
<p class="hint">â€» ì²´í¬ 2ê°œëŠ” í•„ìˆ˜ì´ë©°, ì„œëª…ì€ ì§ì ‘ ê·¸ë ¤ì•¼ í•©ë‹ˆë‹¤. ê°™ì€ ë§í¬ë¡œ ë‹¤ì‹œ ì—´ë©´ ì €ì¥ëœ ë‚´ìš©ì´ ìë™ìœ¼ë¡œ ë³µì›ë©ë‹ˆë‹¤.</p>

<!-- Firebase SDK (ëª¨ë“ˆ ë°©ì‹) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // TODO: ğŸ”´ ì—¬ê¸° ì•„ë˜ë¥¼ ë„¤ Firebase ì½˜ì†”ì—ì„œ ë³µì‚¬í•œ ì„¤ì •ìœ¼ë¡œ êµì²´
  const firebaseConfig = {
    apiKey: "AIzaSyDMu3NnCwJlkAoCmouYu92cP4Rha4SPFKo",
    authDomain: "fuinv-f980f.firebaseapp.com",
    projectId: "fuinv-f980f",
    storageBucket: "fuinv-f980f.firebasestorage.app",
    messagingSenderId: "400376860655",
    appId: "1:400376860655:web:408a516c11ac6aee93f01a"
  };
  // TODO ë

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // URLì—ì„œ id íŒŒë¼ë¯¸í„° ì½ê¸° (ê³„ì•½ ê±´ êµ¬ë¶„ìš©)
  const params = new URLSearchParams(window.location.search);
  let contractId = params.get("id");
  if (!contractId) {
    // id ì—†ìœ¼ë©´ ì„ì‹œë¡œ í•˜ë‚˜ ë§Œë“¤ì–´ì„œ ì£¼ì†Œì— ë¶™ì„
    contractId = "C-" + Math.random().toString(36).slice(2);
    const newUrl = window.location.pathname + "?id=" + contractId;
    window.history.replaceState({}, "", newUrl);
  }

  // ì„œëª… ìº”ë²„ìŠ¤ ë¡œì§
  const canvas = document.getElementById("signCanvas");
  const ctx = canvas.getContext("2d");

  function resizeCanvas() {
    const rect = canvas.getBoundingClientRect();
    canvas.width = rect.width;
    canvas.height = rect.height;
    ctx.lineWidth = 2;
    ctx.lineCap = "round";
    ctx.strokeStyle = "#000";
  }
  window.addEventListener("resize", resizeCanvas);
  resizeCanvas();

  let drawing = false;

  canvas.addEventListener("mousedown", () => { drawing = true; ctx.beginPath(); });
  canvas.addEventListener("mouseup", () => { drawing = false; ctx.beginPath(); });
  canvas.addEventListener("mouseleave", () => { drawing = false; ctx.beginPath(); });
  canvas.addEventListener("mousemove", draw);

  canvas.addEventListener("touchstart", (e) => { e.preventDefault(); drawing = true; ctx.beginPath(); });
  canvas.addEventListener("touchend", (e) => { e.preventDefault(); drawing = false; ctx.beginPath(); });
  canvas.addEventListener("touchmove", (e) => { e.preventDefault(); drawTouch(e); });

  function draw(e) {
    if (!drawing) return;
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    ctx.lineTo(x, y);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(x, y);
  }
  function drawTouch(e) {
    if (!drawing) return;
    const rect = canvas.getBoundingClientRect();
    const touch = e.touches[0];
    const x = touch.clientX - rect.left;
    const y = touch.clientY - rect.top;
    ctx.lineTo(x, y);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(x, y);
  }

  window.clearSign = function() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.beginPath();
  }

  // ì €ì¥
  window.submitForm = async function() {
    const agree1 = document.getElementById("agree1").checked;
    const agree2 = document.getElementById("agree2").checked;
    const name = document.getElementById("name").value.trim();
    const phone = document.getElementById("phone").value.trim();

    if (!agree1 || !agree2) {
      alert("í•„ìˆ˜ ì²´í¬ í•­ëª©ì„ ëª¨ë‘ ì²´í¬í•´ì£¼ì„¸ìš”.");
      return;
    }
    if (!name) {
      alert("ì„±í•¨ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }

    const signatureData = canvas.toDataURL("image/png");

    const data = {
      agree1,
      agree2,
      name,
      phone,
      signatureData,
      updatedAt: new Date()
    };

    try {
      await setDoc(doc(db, "contracts", contractId), data, { merge: true });
      alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
    } catch (e) {
      console.error(e);
      alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
  }

  // ë¶ˆëŸ¬ì˜¤ê¸°
  async function loadData() {
    try {
      const snap = await getDoc(doc(db, "contracts", contractId));
      if (snap.exists()) {
        const data = snap.data();
        document.getElementById("agree1").checked = !!data.agree1;
        document.getElementById("agree2").checked = !!data.agree2;
        document.getElementById("name").value = data.name || "";
        document.getElementById("phone").value = data.phone || "";

        if (data.signatureData) {
          const img = new Image();
          img.onload = function() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          };
          img.src = data.signatureData;
        }
      }
    } catch (e) {
      console.error(e);
    }
  }

  loadData();
</script>

</body>
</html>
